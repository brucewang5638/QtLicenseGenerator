name: Build and Release

on:
  push:
    branches:
      - master
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    runs-on: ${{ matrix.os }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Qt
      uses: jurplel/install-qt-action@v4
      with:
        version: '6.8.1'
        host: ${{ runner.os == 'Linux' && 'linux' || runner.os == 'Windows' && 'windows' || 'mac' }}
        target: 'desktop'
        arch: ${{ runner.os == 'Windows' && 'win64_msvc2022_64' || runner.os == 'macOS' && 'clang_64' || 'gcc_64' }}
        modules: 'qtbase qttools'

    - name: Install CMake and Ninja
      uses: lukka/get-cmake@latest

    - name: Configure MSVC (Windows)
      if: runner.os == 'Windows'
      uses: ilammy/msvc-dev-cmd@v1

    - name: Configure CMake
      run: |
        cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=Release

    - name: Build
      run: |
        cmake --build build --config Release

    - name: Package (Linux)
      if: runner.os == 'Linux'
      run: |
        mkdir -p dist
        cp build/QtLicenseGenerator dist/
        chmod +x dist/QtLicenseGenerator
        cd dist
        tar -czf QtLicenseGenerator-linux-x64.tar.gz QtLicenseGenerator

    - name: Package (Windows)
      if: runner.os == 'Windows'
      run: |
        mkdir dist
        cp build/QtLicenseGenerator.exe dist/
        windeployqt dist/QtLicenseGenerator.exe
        cd dist
        7z a QtLicenseGenerator-windows-x64.zip *

    - name: Package (macOS)
      if: runner.os == 'macOS'
      run: |
        mkdir -p dist
        cp build/QtLicenseGenerator dist/
        chmod +x dist/QtLicenseGenerator
        cd dist
        tar -czf QtLicenseGenerator-macos-x64.tar.gz QtLicenseGenerator

    - name: Upload artifact (Linux)
      if: runner.os == 'Linux'
      uses: actions/upload-artifact@v4
      with:
        name: linux-executable
        path: dist/QtLicenseGenerator-linux-x64.tar.gz

    - name: Upload artifact (Windows)
      if: runner.os == 'Windows'
      uses: actions/upload-artifact@v4
      with:
        name: windows-executable
        path: dist/QtLicenseGenerator-windows-x64.zip

    - name: Upload artifact (macOS)
      if: runner.os == 'macOS'
      uses: actions/upload-artifact@v4
      with:
        name: macos-executable
        path: dist/QtLicenseGenerator-macos-x64.tar.gz

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write

    steps:
    - name: Download Linux executable
      uses: actions/download-artifact@v4
      with:
        name: linux-executable
        path: dist

    - name: Download Windows executable
      uses: actions/download-artifact@v4
      with:
        name: windows-executable
        path: dist

    - name: Download macOS executable
      uses: actions/download-artifact@v4
      with:
        name: macos-executable
        path: dist

    - name: Create Release
      uses: ncipollo/release-action@v1
      with:
        artifacts: |
          dist/QtLicenseGenerator-linux-x64.tar.gz
          dist/QtLicenseGenerator-windows-x64.zip
          dist/QtLicenseGenerator-macos-x64.tar.gz
        body: |
          ## ğŸš€ Qt License Generator ${{ github.ref_name }}

          ### ä½¿ç”¨è¯´æ˜
          1. ä¸‹è½½å¯¹åº”å¹³å°çš„å®‰è£…åŒ…
          2. è§£å‹åè¿è¡Œ `QtLicenseGenerator` å¯æ‰§è¡Œæ–‡ä»¶
          3. ä½¿ç”¨ GUI ç•Œé¢ç”Ÿæˆå’Œç®¡ç†è®¸å¯è¯

          ### å¹³å°æ”¯æŒ
          - **Linux** (x64)
          - **Windows** (x64)
          - **macOS** (x64)

          ### æ–‡ä»¶åˆ—è¡¨
          - **QtLicenseGenerator-linux-x64.tar.gz** - Linux ç‰ˆæœ¬
          - **QtLicenseGenerator-windows-x64.zip** - Windows ç‰ˆæœ¬ (åŒ…å«æ‰€æœ‰å¿…éœ€çš„ Qt è¿è¡Œåº“)
          - **QtLicenseGenerator-macos-x64.tar.gz** - macOS ç‰ˆæœ¬

          ### æŠ€æœ¯æ ˆ
          - Qt 6.8.1
          - C++17
          - CMake æ„å»ºç³»ç»Ÿ
        token: ${{ secrets.GITHUB_TOKEN }}
